import pyshark
import threading
import time
import win32pipe, win32file, pywintypes


# Function to listen for messages on the named pipe
def listen_named_pipe(pipe_name):
    while True:
        print("Waiting for stop message")
        try:
            pipe_handle = win32pipe.CreateNamedPipe(
                pipe_name,
                win32pipe.PIPE_ACCESS_DUPLEX,
                win32pipe.PIPE_TYPE_MESSAGE | win32pipe.PIPE_READMODE_MESSAGE | win32pipe.PIPE_WAIT,
                200, 65536, 65536, 300, None
            )
            win32pipe.ConnectNamedPipe(pipe_handle, None)
            message = win32file.ReadFile(pipe_handle, 4096)
            if message[1] == b"STOP":
                print("received STOP message")
                stop_capture.set()
                break
        except pywintypes.error as e:
            if e.args[0] == 109:  # Pipe ended error code
                continue
            else:
                print("Named pipe error:", e)
                break


if __name__ == '__main__':
    stop_capture = threading.Event()
    capture_file = r"C:\malwareTraces\capture.pcap"
    pipe_name = r'\\.\pipe\captureProcessPipe'

    listen_thread = threading.Thread(target=listen_named_pipe, args=(pipe_name,))
    listen_thread.start()

    with open(capture_file, "w"):
        pass
    capture = pyshark.LiveCapture(interface='Ethernet', output_file=capture_file)

    for packet in capture.sniff_continuously():
        if stop_capture.is_set():
            print("Stopping capture")
            break

    capture.close()
    listen_thread.join()