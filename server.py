from flask import Flask, request, send_file
from werkzeug.utils import secure_filename
import requests
import subprocess
import win32api, win32file
import os
import zipfile
import time

app = Flask(__name__)

UPLOAD_FOLDER = r"C:\malwareTraces\uploads"
INFO_FOLDER = r"C:\malwareTraces\packet_info"
MALWARE_INFO_CSV = r"malware_data.csv"

app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['INFO_FOLDER'] = INFO_FOLDER
app.config['MALWARE_INFO_CSV'] = MALWARE_INFO_CSV

malware_analyzer_pid=0

def create_malware_info_csv():
    info_folder = r"C:\malwareTraces\packet_info"
    malware_csv = r"malware_data.csv"

    csv_fields = ["timestamp", "syscall", "srcIp", "dstIP", 
                "protocol", "srcPort", "dstPort", "pid",
                    "threadId", "ppid", "appName", "domainName" ]

    combined_data = []

    for filename in os.listdir(info_folder):
        if filename.endswith('.txt'):
            file_path = os.path.join(info_folder, filename)

            with open(file_path, 'r') as file:
                lines = file.readlines()
                combined_data.extend(lines)

    combined_data.sort(key=lambda csv_line: csv_line.strip().split(",")[0])

    with open(malware_csv, 'w') as out_file:
        out_file.write(','.join(csv_fields) + '\n')
        out_file.writelines(combined_data)

    print(f'Concatenated data saved to {malware_csv}')
    return

def create_zip():
    result_zip = r"C:\malwareTraces\result.zip"
    capture_file = r"capture.pcap"
    malware_csv = r"malware_data.csv"

    files_to_zip = [malware_csv, capture_file]

    with zipfile.ZipFile(result_zip, 'w') as zipf:
        for file_path in files_to_zip:
            zipf.write(file_path)

    print(f'ZIP file "{result_zip}" created successfully.')
    return

def stop_capture():
    pipe_name = r'\\.\pipe\captureProcessPipe'

    try:
        pipe_handle = win32file.CreateFile(
            pipe_name,
            win32file.GENERIC_READ | win32file.GENERIC_WRITE,
            0, None,
            win32file.OPEN_EXISTING,
            0, None
        )

        win32file.WriteFile(pipe_handle, b"STOP")

    except FileNotFoundError:
        print("Named pipe not found. Make sure the server is running.")
    except Exception as e:
        print("Error:", e)

    finally:
        try:
            win32file.CloseHandle(pipe_handle)
        except NameError:
            pass

def is_pid_running(pid: int) -> bool:
    try:
        handle = win32api.OpenProcess(0x0001, False, pid)
        if handle:
            win32api.CloseHandle(handle)
            return True
        return False
    except Exception as e:
        print(f"Error checking PID: {str(e)}")
        return False

@app.route('/download', methods=['POST'])
def download():
    url = request.form.get('url')
    filename = url.split("/")[-1]
    response = requests.get(url)

    file_path = os.path.join(app.config['UPLOAD_FOLDER'], filename)

    with open(file_path, 'wb') as file:
        file.write(response.content)
    return "File downloaded successfully."

@app.route('/upload', methods=['POST'])
def upload():
    if 'file' not in request.files:
        return "No file part", 404

    file = request.files['file']
    if file.filename == '':
        return "No selected file", 404

    filename = file.filename
    file.save(os.path.join(app.config['UPLOAD_FOLDER'], filename))

    return "File uploaded successfully.", 200

@app.route('/start', methods=['POST'])
def start():
    global malware_analyzer_pid
    python_exe = r"C:\Users\user\AppData\Local\Microsoft\WindowsApps\python3.11.exe"
    capture_script = r"C:\malwareTraces\capture.py"
    capture_process = subprocess.Popen([python_exe, capture_script])

    injector_exe = r"C:\malwareTraces\MalwareTracesInjector.exe"

    data = request.get_json(force=True)
    command = data.get('command', '')
    args = data.get('args', '')

    full_command = []
    full_command.append(injector_exe)

    uploaded_files = os.listdir(app.config['UPLOAD_FOLDER'])
    if command in uploaded_files:
        full_command.append(os.path.join(app.config['UPLOAD_FOLDER'], command))
    else:
        full_command.append(command)

    full_command.append(args)
    #print(full_command)
    time.sleep(2)
    
    injector_process = subprocess.Popen(full_command)
    malware_analyzer_pid = injector_process.pid
    
    return "Starting Malware Analyzer", 200, {'content-type': 'text/html'}

@app.route('/stop', methods=['GET'])
def stop():
    pipe_name = r'\\.\pipe\captureProcessPipe'

    try:
        pipe_handle = win32file.CreateFile(
            pipe_name,
            win32file.GENERIC_READ | win32file.GENERIC_WRITE,
            0, None,
            win32file.OPEN_EXISTING,
            0, None
        )

        win32file.WriteFile(pipe_handle, b"STOP")

    except FileNotFoundError:
        print("Named pipe not found. Make sure the server is running.")
    except Exception as e:
        print("Error:", e)

    finally:
        try:
            win32file.CloseHandle(pipe_handle)
        except NameError:
            pass
    return "Stopping program", 200, {'content-type': 'text/html'}

@app.route('/check', methods=['GET'])
def check():
    global malware_analyzer_pid
    if is_pid_running(malware_analyzer_pid):
        return "Program is running", 200, {'Content-Type': 'text/html'}

    return "Program is NOT running", 404, {'Content-Type': 'text/html'}

@app.route('/result', methods=['GET'])
def result():

    stop_capture()
    create_malware_info_csv()
    create_zip()

    result_zip = r"C:\malwareTraces\result.zip"

    if not (os.path.exists(result_zip)):
        return "Files not available", 404, {'Content-Type': 'text/html'}

    return send_file(result_zip, as_attachment=True)

if __name__ == '__main__':
    if not os.path.exists(INFO_FOLDER):
        os.makedirs(INFO_FOLDER)

    if not os.path.exists(UPLOAD_FOLDER):
        os.makedirs(UPLOAD_FOLDER)

    app.run(host='0.0.0.0', port=5000)